@using Pie.Data.Models.Out;
<div>
    @*<QuickGrid Items="@(doc?.Products?.AsQueryable<DocOutProduct>())" Class="table table-bordered table-hover">*@
    <QuickGrid Items="@FilteredProducts" Class="table table-sm table-bordered border-2 table-hover" Theme="corporate">
        <PropertyColumn Property="@(p => p.LineNumber)" Title="№" Sortable="true"></PropertyColumn>
        <PropertyColumn Property="@(p => p.Product != null ? p.Product.Name : string.Empty)" Title="Товар" Sortable="true">
            <ColumnOptions>
                <div class="search-box">
                    <input type="search" autofocus @bind="nameFilter" @bind:event="oninput" placeholder="Название..." />
                </div>
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="@(p => p.CountPlan)" Title="Кол" Sortable="true"></PropertyColumn>
        @if (DocVm?.Value?.Status?.CanChange ?? false)
        {
            @*<PropertyColumn Property="@(p => p.CountFact)" Title="Кол-во факт" Sortable="true"></PropertyColumn>*@
            <TemplateColumn Title="Кол факт" Class="p-0 m-0">
                <div class="@(context.CountPlan == context.CountFact ? string.Empty : "alert  alert-warning") m-0 p-2">
                    @{
                        string? changeReason = ChangeReasons?.FirstOrDefault(c => c.Id == context.ChangeReasonId)?.Name;
                        changeReason = string.IsNullOrEmpty(changeReason) ? string.Empty : $@" ( {changeReason} ) ";
                    }
                    @context.CountFact @changeReason
                </div>
            </TemplateColumn>
        }
        <PropertyColumn Property="@(p => p.Unit)" Title="Упак" Sortable="true" />
        <PropertyColumn Property="@(p => p.Weight)" Title="Вес" Sortable="true" />
        @if (DocVm?.Value?.Status?.CanChange ?? false)
        {
            <TemplateColumn Title="Изменить" Class="d-print-none">
                <button class="btn btn-outline-primary" @onclick="@(() => EditDoc(context))"><i class="bi bi-pencil-square"></i></button>
            </TemplateColumn>
        }
    </QuickGrid>
</div>
@if (DocVm != null && DocVm.Value != null && DocVm.Value.Products != null)
{
    <table class="table table-sm table-striped table-bordered">
        <thead>
            <tr>
                <th class="text-center">№</th>
                <th class="text-center">Артикул</th>
                <th class="text-center">Товар</th>
                <th class="text-center">Кол</th>
                @if (DocVm?.Value?.Status?.CanChange ?? false)
                {
                    <th class="text-center">Кол факт</th>
                }
                <th class="text-center">Упак</th>
                <th class="text-center">Вес</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in DocVm.Value.Products)
            {
                <tr>
                    <td>@item.LineNumber</td>
                    <td>@item.Product?.Code</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            }
        </tbody>

    </table>
}

<EditDialog @ref="EditDialog" ChangeReasons="@ChangeReasons" OnSaveChanges="@UpdateDoc"></EditDialog>

@code {
    [Parameter] public DocOutVm? DocVm { get; set; }
    [Parameter] public List<ChangeReasonOut>? ChangeReasons { get; set; }
    private EditDialog? EditDialog { get; set; }

    string? nameFilter;
    IQueryable<DocOutProduct>? FilteredProducts
    {
        get
        {
            var result = DocVm?.Value?.Products?.AsQueryable();

            if (!string.IsNullOrEmpty(nameFilter))
            {
                result = result?.Where(p =>
                    p.Product != null && p.Product.Name != null && p.Product.Name.Contains(nameFilter, StringComparison.CurrentCultureIgnoreCase));
            }
            return result;
        }
    }

    private void EditDoc(DocOutProduct product)
    {
        EditDialog?.Open(product);
    }

    private void UpdateDoc()
    {
        EditDialog?.Close();
    }
}
